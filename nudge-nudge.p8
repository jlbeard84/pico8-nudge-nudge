pico-8 cartridge // http://www.pico-8.com
version 15
__lua__
--nudge-nudge
-- by jbeard

level=1
gridsquare=8
levelfinished=false
floorsprite=7

player={}
player.x=0
player.y=0

blockcount=0
blocks={}

portal={}
portal.x=gridsquare*5
portal.y=gridsquare*8
portalsprites={2,3,4}
portalspritelength=3
portalcounter=1
portalspriteiterator=1
portalspritespeed=5

function _init()

	blocks={}
	blockcount=0

	for i=0,15,1 do
		for j=0,16,1 do
		
		 sprite=mget(i,j)
		 
			if fget(sprite,1)==true then
				mset(i,j,7)
				blockcount+=1
				add(blocks,{x=i*gridsquare,y=j*gridsquare })
			elseif fget(sprite,2)==true then
				mset(i,j,7)
				portal.x=i*gridsquare
				portal.y=j*gridsquare
			elseif fget(sprite,3)==true then
				mset(i,j,7)
				player.x=i*gridsquare
				player.y=j*gridsquare
			end
		end
	end


	--player.x=gridsquare
	--player.y=gridsquare
	
	
	
	--for i=1,blockcount,1 do
	--	
	--end

end

function moveplayer()
 
 mvmtx=0
 mvmty=0
 
 if btnp(0) then
 	mvmtx-=gridsquare
 elseif btnp(1) then
 	mvmtx+=gridsquare
 elseif btnp(2) then
  mvmty-=gridsquare
 elseif btnp(3) then
  mvmty+=gridsquare
 end
 
 player.x+=mvmtx
 player.y+=mvmty

 solidblock=fget(mget(player.x/gridsquare,player.y/gridsquare),0)
 
 for block in all(blocks) do
 
		if checkboundingcollision(player,block)==true then
					
				block.x+=mvmtx
				block.y+=mvmty
				
				if checkboundingcollision(block,portal) then
					del(blocks,block)
					blockcount-=1
					
					if blockcount==0 then
						levelfinished=true
					end
					
					return
				end

				blockpossolid=fget(mget(block.x/gridsquare,block.y/gridsquare),0)

				if blockpossolid==true then
					block.x-=mvmtx
					block.y-=mvmty
					player.x-=mvmtx
					player.y-=mvmty
							
					return		
				end
				
				for adjacantblock in all(blocks) do
					if block~=adjacantblock and
					 checkboundingcollision(block,adjacantblock)==true then
						
							block.x-=mvmtx
							block.y-=mvmty
							player.x-=mvmtx
							player.y-=mvmty
							
							return				
					end
				end
				
			
				if checkedgecollision(block)==true or solidblock==true then
					player.x-=mvmtx
					player.y-=mvmty
				end
			
				return
		end
 end

 checkedgecollision(player)

 if solidblock==true then
 	player.x-=mvmtx
 	player.y-=mvmty
 end
end

function checkboundingcollision(left,right)

	if left.x < right.x+gridsquare and
 	left.x+gridsquare > right.x and
 	left.y < right.y+gridsquare and
 	left.y+gridsquare > right.y then
 
 		return true
 end
 
 return false
end

function checkedgecollision(actor)
	if actor.x < 0 then
 	actor.x=0
 	sfx(0)
 	return true
 elseif actor.x > 127 then
 	actor.x=120
 	sfx(0)
 	return true
 elseif actor.y < 0 then
 	actor.y=0
 	sfx(0)
 	return true
 elseif actor.y > 119 then
 	actor.y=112
 	sfx(0)
 	return true
 end
 
 return false
end

function updateanimations()
	portalspriteiterator+=1
	
	if portalspriteiterator>portalspritespeed then
		portalspriteiterator=1
		portalcounter+=1
		
		if portalcounter>portalspritelength then
			portalcounter=1
		end
	end
end

function _update()

	if btnp(5) then
		_init()
		return
	end

	moveplayer()
	updateanimations()
end

function drawhud()
	rectfill(0,120,127,127,0)
	rect(0,120,127,128,7)
	
	if levelfinished==true then
		print("win",45,122,7)
	end
	
	print("level "..level,2,122,7)
	print("remaining "..blockcount,76,122,7)
end

function drawactors()
	
	spr(portalsprites[portalcounter],portal.x,portal.y)
	
	for i=1,blockcount,1 do
		spr(005,blocks[i].x,blocks[i].y)
	end
	
	spr(001,player.x,player.y)
end

function _draw()
	rectfill(0,0,127,119,3)
	map(0, 0, 0, 0, 16, 15)
	drawactors()
	drawhud()
end

__gfx__
0000000000aaaa007cccccc7cccccc7cccc7cccc00044000665665663b3b3b3b0000000000000000000000000000000000000000000000000000000000000000
000000000aaaaaa0cc7777cc77777c7cc77c777c0044540055555555b3b3b3b30000000000000000000000000000000000000000000000000000000000000000
00700700aacaacaac7c66c7ccc66c67cc76c667c04454440656656653b3b3b3b0000000000000000000000000000000000000000000000000000000000000000
00077000aa1aa1aac761167cc7c1167cc7611cc74544454555555555b3b3b3b30000000000000000000000000000000000000000000000000000000000000000
00077000aaaaaaaac761167cc7611c7c7cc1167c44544444665665663b3b3b3b0000000000000000000000000000000000000000000000000000000000000000
00700700a8aaaa8ac7c66c7cc76c66ccc766c67c0444544055555555b3b3b3b30000000000000000000000000000000000000000000000000000000000000000
000000000a8888a0cc7777ccc7c77777c777c77c00444400656656653b3b3b3b0000000000000000000000000000000000000000000000000000000000000000
0000000000aaaa007cccccc7c7cccccccccc7ccc0005400055555555b3b3b3b30000000000000000000000000000000000000000000000000000000000000000
__label__
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333aaaa33333443333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333aaaaaa3334454333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
333333333333333333333333aacaacaa344544433333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
333333333333333333333333aa1aa1aa454445453333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
333333333333333333333333aaaaaaaa445444443333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
333333333333333333333333a8aaaa8a344454433333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
3333333333333333333333333a8888a3334444333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333aaaa33333543333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333443333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333334454333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333344544433333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333454445453333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333445444443333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333344454433333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333334444333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333543333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
33333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333
77777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777777
70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007
70700077707070777070000000770000000000000000000000000000000000000000000000007770777077707770777077007770770007700000777000000007
70700070007070700070000000070000000000000000000000000000000000000000000000007070700077707070070070700700707070000000007000000007
70700077007070770070000000070000000000000000000000000000000000000000000000007700770070707770070070700700707070000000777000000007
70700070007770700070000000070000000000000000000000000000000000000000000000007070700070707070070070700700707070700000700000000007
70777077700700777077700000777000000000000000000000000000000000000000000000007070777070707070777070707770707077700000777000000007
70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007

__gff__
0008040404020100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0606060606060606060606060606060600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0607070707070707070707070707070600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0607020707070707070707070707070600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0607070707070707070707070606060600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0606060606060606060606050606060600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0607070707070707070707050707070600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0607070707070707070707070707070600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0607070707070707070707070707070600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0607070707070707070707070707070600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0607070707070707070707070707070600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0607070107070707070707070707070600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0607070707070707070707070707070600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0607070707070707070707070707070600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0607070707070707070707070707070600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0606060606060606060606060606060600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100000b0500805007050070500705008050090500705001050216001f6001e6001c6001b6001b6001a6001a600196001960019600196001960019600196001960019600196001960019600196001960019600
010f00001c5500f550105500c5500c5500c550105501755015550185501655014550125500f5500d55017550155501355011550105500e5500c55005550000000000000000000000000000000000000000000000
001000000155001500015500150001550015000255000000025500000002550015000155000000015500000002550000000255000000015500000001550000000255000000025500000001570000000157000000
__music__
00 01024344

